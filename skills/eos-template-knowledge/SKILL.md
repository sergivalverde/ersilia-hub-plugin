---
name: eos-template-knowledge
description: >
  Knowledge base for the Ersilia Model Hub eos-template format. Use when the user asks about
  "incorporating a model into Ersilia", "eos-template", "Ersilia Model Hub model wrapper",
  "model contribution to Ersilia", or when working with eosXXXX model repositories.
version: 1.0.0
---

# Ersilia Model Hub — eos-template Reference

The Ersilia Model Hub wraps published ML models into a standardized format so they can be fetched, served, and run via the `ersilia` CLI. Every model follows the **eos-template** structure.

## Repository Structure

```
<model-id>/                          # e.g. eos4e40/
├── model/
│   ├── checkpoints/                 # Pre-trained weights (.pt, .h5, .pkl, .joblib, etc.)
│   │   └── model.pt
│   └── framework/
│       ├── code/
│       │   └── main.py              # CSV-in / CSV-out wrapper (MANDATORY)
│       ├── run.sh                   # Entry point script (MANDATORY)
│       ├── examples/
│       │   ├── run_input.csv        # 3 SMILES test inputs (MANDATORY)
│       │   └── run_output.csv       # Expected outputs for those 3 inputs (MANDATORY)
│       └── columns/
│           └── run_columns.csv      # Output column metadata (MANDATORY)
├── install.yml                      # Dependency specification (MANDATORY)
├── metadata.yml                     # Model card metadata (MANDATORY)
├── Dockerfile                       # Auto-generated by CI, do not create manually
├── LICENSE
└── README.md                        # Auto-generated from metadata, do not edit
```

## main.py Contract

The core wrapper script. It must:

- Accept two positional arguments: `sys.argv[1]` = input CSV path, `sys.argv[2]` = output CSV path
- Read input CSV (first column after header, typically SMILES strings)
- Run the model inference
- Write output CSV with prediction columns (NO input/smiles/key columns in output)
- Guarantee `len(input_rows) == len(output_rows)`

### Template Pattern

```python
import os
import csv
import sys

# Parse arguments
input_file = sys.argv[1]
output_file = sys.argv[2]

# Paths
root = os.path.dirname(os.path.abspath(__file__))
checkpoints_dir = os.path.join(root, "..", "..", "checkpoints")

# Read input
with open(input_file, "r") as f:
    reader = csv.reader(f)
    next(reader)  # skip header
    smiles_list = [r[0] for r in reader]

# Run model
outputs = my_model(smiles_list)  # replace with actual inference call

# Verify
assert len(smiles_list) == len(outputs)

# Write output
with open(output_file, "w") as f:
    writer = csv.writer(f)
    writer.writerow(["prediction_column"])  # header matching run_columns.csv
    for o in outputs:
        writer.writerow([o])
```

### Common Inference Patterns

**Pattern A — Direct import** (source code copied into `code/`):
```python
sys.path.append(os.path.join(root, "src"))
from model import predict
outputs = predict(smiles_list)
```

**Pattern B — Checkpoint loading** (PyTorch/TF/sklearn):
```python
import torch
model = torch.load(os.path.join(checkpoints_dir, "model.pt"), map_location="cpu")
model.eval()
```

**Pattern C — Library call** (pip-installable model):
```python
from biosynfoni import Biosynfoni
from rdkit import Chem
fps = [Biosynfoni(Chem.MolFromSmiles(smi)).fingerprint for smi in smiles_list]
```

## run.sh Contract

Always exactly:
```bash
python $1/code/main.py $2 $3
```
Where `$1` = framework directory path, `$2` = input CSV, `$3` = output CSV.

## install.yml Format

```yaml
python: "3.10"
commands:
    - ["pip", "library-name", "version"]
    - ["pip", "library-name", "version", "--index-url", "URL"]
    - ["pip", "git+https://github.com/org/repo.git@commit"]
    - ["conda", "library-name", "version", "channel"]
    - "any bash command as a string"
```

Rules:
- Python version: one of 3.8, 3.9, 3.10, 3.11, 3.12
- Always pin versions for reproducibility
- Use conda for compiled packages (rdkit, numpy, scipy, pytorch)
- Use pip for pure-Python packages
- Common conda channels: default, conda-forge, pytorch

## metadata.yml Format

```yaml
Identifier: eos0xxx
Slug: short-lowercase-name
Status: In progress
Title: Short model title (10-300 chars)
Description: |
  Detailed description of what the model does, how it works,
  and what it was trained on. Minimum 200 characters.
  Must differ from Title.
Deployment:
  - Local
Source: Local
Source Type: External
Task: Annotation
Subtask: Activity prediction
Input:
  - Compound
Input Dimension: 1
Output:
  - Score
Output Dimension: 1
Output Consistency: Fixed
Interpretation: |
  How to interpret the model output (10-300 chars).
Tag:
  - Antimicrobial activity
  - E.coli
Biomedical Area:
  - Antimicrobial resistance
Target Organism:
  - Escherichia coli
Publication Type: Peer reviewed
Publication Year: 2025
Publication: https://doi.org/...
Source Code: https://github.com/...
License: MIT
```

## Valid Metadata Vocabulary

### Status
Test, In maintenance, In progress, Ready, Archived

### Task
Representation, Annotation, Sampling

### Subtask
Featurization, Projection, Property calculation or prediction, Activity prediction, Similarity search, Generation

### Input
Compound, Protein, Text

### Output
Compound, Score, Value, Text

### Output Consistency
Fixed, Variable

### Biomedical Area
Any, ADMET, Antimicrobial resistance, Malaria, Tuberculosis, COVID-19, Gonorrhea, Cancer, Mycetoma, AIDS, Schistosomiasis, Hepatitis, Alzheimer, Chagas, Cryptosporidiosis, Leprosy

### Publication Type
Peer reviewed, Preprint, Other

### Source
Local, Online

### Source Type
External, Replicated, Internal

### Deployment
Local, Online

### License
MIT, GPL-3.0-only, GPL-3.0-or-later, LGPL-3.0-only, LGPL-3.0-or-later, AGPL-3.0-only, AGPL-3.0-or-later, Apache-2.0, BSD-2-Clause, BSD-3-Clause, MPL-2.0, CC-BY-3.0, CC-BY-4.0, CC0-1.0, Proprietary, None

### Tag
AIDS, Alzheimer, Cancer, Cardiotoxicity, Cytotoxicity, COVID19, Dengue, Malaria, Neglected tropical disease, Schistosomiasis, Tuberculosis, A.baumannii, E.coli, E.faecium, HBV, HIV, HDAC1, Human, K.pneumoniae, Mouse, M.tuberculosis, P.aeruginosa, P.falciparum, N.gonorrhoeae, Rat, Sars-CoV-2, S.aureus, ESKAPE, BACE, CYP450, GPCR, hERG, Fraction bound, IC50, Half-life, LogD, LogP, LogS, MIC90, Molecular weight, Papp, pKa, ADME, Antimicrobial activity, Antiviral activity, Bioactivity profile, Lipophilicity, Metabolism, Microsomal stability, Natural product, Price, Quantum properties, Permeability, Side effects, Solubility, Synthetic accessibility, Target identification, Therapeutic indication, Toxicity, ChEMBL, DrugBank, MoleculeNet, Tox21, ToxCast, TDCommons, ZINC, Chemical graph model, Chemical language model, Chemical notation, Chemical synthesis, Compound generation, Descriptor, Drug-likeness, Embedding, Fingerprint, Similarity, Biomedical text, Mycetoma, Antifungal activity, Frequent hitter

### Target Organism
Homo sapiens, Mus musculus, Rattus norvegicus, Plasmodium falciparum, Plasmodium vivax, Mycobacterium tuberculosis, Fast-acid bacteria, Fungi, Gram-negative bacteria, Gram-positive bacteria, Schistosoma mansoni, Madurella mycetomatis, Burkholderia cenocepacia, Acinetobacter baumannii, Neisseria gonorrhoeae, Staphylococcus aureus, Pseudomonas aeruginosa, Enterobacteriaceae spp, Enterococcus faecium, Escherichia coli, Helicobacter pylori, Campylobacter spp, Salmonella spp, Streptococcus pneumoniae, Haemophilus influenzae, Shigella spp, SARS-CoV-2, SARS-CoV-1, MERS, Hepatitis B virus, Hepatitis C virus, HIV, Ebola virus, Any, Klebsiella pneumoniae, plus gut microbiome organisms (Akkermansia muciniphila, Bacteroides spp, Bifidobacterium spp, etc.)

## run_columns.csv Format

```csv
name,type,direction,description
score,float,high,Predicted probability of bioactivity
```

- **type**: float, integer, string, other
- **direction**: high (higher is better), low (lower is better), or empty (no directionality)
- One row per output column

## Example Files

### run_input.csv
Always 3 representative SMILES with header `smiles`:
```csv
smiles
CC(=O)Oc1ccccc1C(=O)O
CC(C)Cc1ccc(cc1)C(C)C(=O)O
Cn1c(=O)c2c(ncn2C)n(c1=O)C
```
These are aspirin, ibuprofen, and caffeine — safe defaults when the model accepts generic small molecules.

### run_output.csv
Matching 3 rows of output (no header smiles column, just prediction columns):
```csv
score
0.85
0.42
0.13
```

## Deep Validation Reference Data

The following reference compounds and mappings are used by the `--level deep` test to validate that models produce scientifically meaningful outputs.

### DIVERSE_50 — Chemical Space Coverage Set

50 molecules spanning molecular weight, polarity, ring systems, and functional groups. Used for distribution analysis on all model types.

```python
DIVERSE_50 = [
    "CC(=O)Oc1ccccc1C(=O)O",                          # aspirin
    "CC(C)Cc1ccc(cc1)C(C)C(=O)O",                     # ibuprofen
    "Cn1c(=O)c2c(ncn2C)n(c1=O)C",                     # caffeine
    "CC(=O)Nc1ccc(O)cc1",                              # acetaminophen
    "OC(=O)c1ccccc1O",                                 # salicylic acid
    "c1ccc2c(c1)cc1ccc3cccc4ccc2c1c34",                # pyrene
    "O=C(O)C(N)Cc1ccccc1",                             # phenylalanine
    "CC12CCC3C(CCC4CC(=O)CCC34C)C1CCC2O",             # testosterone
    "CN1C(=O)CN=C(c2ccccc2)c2cc(Cl)ccc21",            # diazepam
    "CC(CS)C(=O)N1CCCC1C(=O)O",                       # captopril
    "Clc1ccc(cc1)C(c1ccc(Cl)cc1)C(Cl)(Cl)Cl",        # DDT
    "CC(C)NCC(O)c1ccc(O)c(O)c1",                      # isoprenaline
    "OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O",       # glucose
    "c1ccc(cc1)-c1ccccc1",                             # biphenyl
    "NCCc1c[nH]c2ccc(O)cc12",                         # serotonin
    "CC(C)(C)NCC(O)c1ccc(O)c(CO)c1",                  # salbutamol
    "OC(=O)c1cc(O)c(O)c(O)c1",                        # gallic acid
    "O=c1[nH]c(=O)c2[nH]cnc2[nH]1",                  # uric acid
    "FC(F)(F)c1ccc(cc1)S(=O)(=O)N",                   # trifluoromethylbenzenesulfonamide
    "CC1=CC(=O)c2c(O)cccc2C1=O",                      # plumbagin
    "c1ccc(-c2ccccn2)nc1",                             # bipyridine
    "O=C(O)CCCCCCCCCCCCCCC",                           # palmitic acid
    "CCCCCCCCCCCCCCCCCCCC",                            # eicosane
    "c1ccc2[nH]ccc2c1",                               # indole
    "O=Cc1ccc(O)c(OC)c1",                             # vanillin
    "Nc1ccc(N)cc1",                                    # p-phenylenediamine
    "ClC(Cl)=C(Cl)Cl",                                # tetrachloroethylene
    "O=C(O)c1ccc(N)cc1",                              # 4-aminobenzoic acid
    "CCOC(=O)c1ccccc1N",                              # benzocaine
    "O=S(=O)(c1ccccc1)c1ccccc1",                      # diphenylsulfone
    "c1ccncc1",                                        # pyridine
    "c1cc[nH]c1",                                      # pyrrole
    "c1ccoc1",                                         # furan
    "c1ccsc1",                                         # thiophene
    "NCCCCN",                                          # putrescine
    "OC(=O)C=CC(=O)O",                                # fumaric acid
    "CC(=O)NCCC1=CNC2=C1C=C(OC)C=C2",                # melatonin
    "O=C(O)c1cccnc1",                                 # nicotinic acid
    "CC1(C)SC2C(NC(=O)Cc3ccccc3)C(=O)N2C1C(=O)O",   # penicillin G
    "OC1C(O)C(O)C(O)C(O)C1O",                        # inositol
    "Nc1ncnc2[nH]cnc12",                              # adenine
    "NCC(=O)O",                                        # glycine
    "O=C(O)C(N)CC(=O)O",                              # aspartate
    "OC(=O)c1cn(C2CC2)c2cc(N3CCNCC3)c(F)cc2c1=O",   # ciprofloxacin
    "ClC(Cl)(Cl)Cl",                                   # carbon tetrachloride
    "O",                                               # water
    "CC(O)CC(=O)c1ccccc1",                            # benzoyacetone
    "CC(=O)c1ccc(cc1)S(C)(=O)=O",                    # methylsulfonylphenone
    "O=C(O)C(O)C(O)C(=O)O",                          # tartaric acid
    "c1ccc(cc1)-c1ccc(cc1)-c1ccccc1",                 # terphenyl
]
```

### SANITY_COMPOUNDS — Domain-Specific Reference Sets

Compounds with known properties organized by domain. Each entry: `(SMILES, name)`. Positive = expected active/high; Negative = expected inactive/low.

```python
SANITY_COMPOUNDS = {
    "antimicrobial": {
        "positive": [
            ("CC1(C)SC2C(NC(=O)Cc3ccccc3)C(=O)N2C1C(=O)O", "penicillin_G"),
            ("OC(=O)c1cn(C2CC2)c2cc(N3CCNCC3)c(F)cc2c1=O", "ciprofloxacin"),
            ("NC(=O)c1ccc(O)c(O)c1", "aminosalicylic_acid"),
        ],
        "negative": [
            ("OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O", "glucose"),
            ("CCCCCCCCCCCCCCCCCCCC", "eicosane"),
            ("O", "water"),
        ]
    },
    "toxicity": {
        "positive": [
            ("Clc1ccc(cc1)C(c1ccc(Cl)cc1)C(Cl)(Cl)Cl", "DDT"),
            ("O=[As](O)(O)O", "arsenate"),
            ("ClC(Cl)(Cl)Cl", "carbon_tetrachloride"),
        ],
        "negative": [
            ("OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O", "glucose"),
            ("O=C(O)C(N)CC(=O)O", "aspartate"),
            ("O", "water"),
        ]
    },
    "solubility": {
        "high_soluble": [
            ("OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O", "glucose"),
            ("O=C(O)C(N)CC(=O)O", "aspartate"),
            ("NCC(=O)O", "glycine"),
        ],
        "low_soluble": [
            ("c1ccc2c(c1)cc1ccc3cccc4ccc2c1c34", "pyrene"),
            ("CCCCCCCCCCCCCCCCCCCC", "eicosane"),
            ("c1ccc(cc1)-c1ccc(cc1)-c1ccccc1", "terphenyl"),
        ]
    },
    "lipophilicity": {
        "high_logp": [
            ("CCCCCCCCCCCCCCCCCCCC", "eicosane"),
            ("Clc1ccc(cc1)C(c1ccc(Cl)cc1)C(Cl)(Cl)Cl", "DDT"),
            ("c1ccc2c(c1)cc1ccc3cccc4ccc2c1c34", "pyrene"),
        ],
        "low_logp": [
            ("OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O", "glucose"),
            ("NCC(=O)O", "glycine"),
            ("OC(=O)C(O)C(O)C(=O)O", "tartaric_acid"),
        ]
    },
    "cardiotoxicity": {
        "positive": [
            ("CN1C(=O)CN=C(c2ccccc2)c2cc(Cl)ccc21", "diazepam"),
            ("CC(CS)C(=O)N1CCCC1C(=O)O", "captopril"),
        ],
        "negative": [
            ("CC(=O)Oc1ccccc1C(=O)O", "aspirin"),
            ("CC(=O)Nc1ccc(O)cc1", "acetaminophen"),
        ]
    },
    "fingerprint": {
        "similar_pair": [
            ("CC(=O)Oc1ccccc1C(=O)O", "aspirin"),
            ("OC(=O)c1ccccc1O", "salicylic_acid"),
        ],
        "dissimilar_pair": [
            ("CCCCCCCCCCCCCCCCCCCC", "eicosane"),
            ("Nc1ncnc2[nH]cnc12", "adenine"),
        ]
    },
    "malaria": {
        "positive": [
            ("CCN(CC)c1cc2nc3cc(Cl)ccc3c(N)c2cc1", "chloroquine_analog"),
            ("OC(=O)c1cc(O)c(O)c(O)c1", "gallic_acid"),
        ],
        "negative": [
            ("OC[C@H]1OC(O)[C@H](O)[C@@H](O)[C@@H]1O", "glucose"),
            ("CCCCCCCCCCCCCCCCCCCC", "eicosane"),
        ]
    },
}
```

### TAG_TO_SANITY_KEY — Metadata to Sanity Category Mapping

Maps model Tags and Biomedical Areas to the appropriate sanity check category.

```python
TAG_TO_SANITY_KEY = {
    "Antimicrobial activity": "antimicrobial",
    "Antifungal activity": "antimicrobial",
    "Antiviral activity": "antimicrobial",
    "MIC90": "antimicrobial",
    "IC50": "antimicrobial",
    "Toxicity": "toxicity",
    "Cytotoxicity": "toxicity",
    "Cardiotoxicity": "cardiotoxicity",
    "hERG": "cardiotoxicity",
    "Solubility": "solubility",
    "LogS": "solubility",
    "ADME": "solubility",
    "Lipophilicity": "lipophilicity",
    "LogP": "lipophilicity",
    "LogD": "lipophilicity",
    "Fingerprint": "fingerprint",
    "Embedding": "fingerprint",
    "Descriptor": "fingerprint",
    "Malaria": "malaria",
    "P.falciparum": "malaria",
}

BIOMEDICAL_AREA_TO_SANITY_KEY = {
    "Antimicrobial resistance": "antimicrobial",
    "Malaria": "malaria",
    "ADMET": "solubility",
    "Cancer": "toxicity",
}
```

**Resolution algorithm**:
1. Iterate through model's `Tag` list, collect all matching sanity keys
2. Iterate through `Biomedical Area` list, add any additional keys
3. If `Task` is `Representation` and no keys matched, default to `"fingerprint"`
4. If `Task` is `Sampling`, skip sanity checks (distribution analysis still runs)
5. If no keys matched, skip sanity checks with WARNING status

### Sanity Check Interpretation

**For Annotation models** (Score/Value output):
- Read `direction` from `run_columns.csv`
- If direction is `high`: expect mean(positive) > mean(negative)
- If direction is `low`: expect mean(positive) < mean(negative)
- For multi-column output, check each column using its own direction

**For Representation models** (fingerprints/embeddings):
- Compute cosine similarity between vectors of the similar pair
- Compute cosine similarity between vectors of the dissimilar pair
- Expect: similarity(similar_pair) > similarity(dissimilar_pair)

**For solubility/lipophilicity** (bidirectional):
- Use `high_soluble`/`low_soluble` or `high_logp`/`low_logp` groups
- Direction from run_columns.csv determines which group is "positive"

### Pass/Fail Criteria

| Check | PASS | WARNING | FAIL |
|-------|------|---------|------|
| Distribution: completeness | >= 90% valid | 70-90% | < 70% |
| Distribution: non-constant | std > 1e-6 | — | All identical (std=0) |
| Distribution: finite values | All finite | — | Any inf |
| Distribution: runtime | < 300s for 50 molecules | 300-600s | > 600s |
| Sanity: directional separation | Correct direction | Marginal (<10% diff) | Reversed |
| Fingerprint: similarity | Similar > dissimilar | — | Reversed |
| Paper: metric reproduction | Within 20% of reported | Within 50% or skipped | Never hard-fails |
